<!DOCTYPE html>
<html lang="en">
<head>
  <title>Order of Saints</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script type="text/babel" >
        "use strict";
      
      const user = `user${(Math.floor((Math.random() * 1000)) + 1)}`;
      var room;
      let socket;
      let draws = {};
      var canvas = document.getElementById('myCanvas');
      var ctx = canvas.getContext('2d');
      
      //object to keep track of pressed keys
      var keysDown = {};
       
      //draw all shapes in stack
      const draw = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.font = "50px Arial";
        ctx.fillText(room, 10, 50);
        
        let keys = Object.keys(draws);
        
        //draw players
        for(let i = 0; i < keys.length; i++)
        {
          const drawCall = draws[keys[i]];
          
          ctx.beginPath();
          ctx.arc(drawCall.x, drawCall.y, drawCall.rad, 0, 2 * Math.PI);
          ctx.fillStyle = drawCall.fill;
          ctx.fill();
          ctx.strokeStyle = drawCall.stroke;
          ctx.lineWidth = 5;
          ctx.stroke();
          //ctx.closePath();
        }
        
      }
      
      const setupPlayer = () => {
        const time = new Date().getTime();
        let x = canvas.width/2;
        let y = canvas.height/2;
        let fill = '#' + ("000000" + Math.random().toString(16).slice(2, 8).toUpperCase()).slice(-6); //code from http://www.daverabideau.com/blog/
        let stroke = '#' + ("000000" + Math.random().toString(16).slice(2, 8).toUpperCase()).slice(-6);
        draws[user] = {lastUpdate: time, x: x, y: y, rad: 25, fill: fill, stroke: stroke};
      }
      
      const setupEnemies = (enemies) => {
        let keys = Object.keys(enemies);
        
        for(var i = 0; i < keys.length; i++)
        {
          const enemy = enemies[keys[i]];
          ctx.beginPath();
          ctx.arc(enemy.x, enemy.y, enemy.rad, 0, 2 * Math.PI);
          ctx.fillStyle = enemy.fill;
        }
      }
      
      
      //add parameters from server to draw stack
      const handleDraw = (data) => {
        if(!draws[data.name])
        {
          draws[data.name] = data.coords;
        }
        else if(data.coords.lastUpdate > draws[data.name].lastUpdate)
        {
          draws[data.name] = data.coords;
        }
        draw();
      }
      
      const handleMove = (data) => {
        socket.emit('draw', {name: data.name, coords: data.coords});
      }
      
      const handleLeave = (data) =>{
        delete draws[data.user];
      }
      
      const sendKeys = () => {
        socket.emit('movement', {name: user, keysDown:keysDown, coords: draws[user], winWidth: window.innerWidth, winHeight: window.innerHeight});
      }
      
      const moveEnemies = () => {
        socket.emit('updateEnemies', { room: room, x: draws[user].x, y: draws[user].y });
      }
      
      const redrawCanvas = () => {
        ctx.strokeRect(0,0, window.innerWidth, window.innerHeight);
      }
      
      const resizeCanvas = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        redrawCanvas();
      }
      
      const displayRoom = (roomName) => {
        console.log("display room");
        room = roomName;
        draw();
      }
    
      const init = () => {
      
        window.addEventListener('resize', resizeCanvas, false); //resize canvas to window size
        resizeCanvas(); //first canvas draw
        
        socket = io.connect();
        
        socket.on('connect', () => {
          //add a circle to the data structure upon connecting
          socket.emit('join', {name: user, spawnWidth: window.innerWidth, spawnHeight: window.innerHeight});
          setupPlayer();
          draw();
          setInterval(sendKeys, 50);
        });
        
        //keep track of keysDown that are down
        document.onkeydown = (e) => {
          keysDown[e.keyCode] = true;
        };
        document.onkeyup = (e) => {
          keysDown[e.keyCode] = false;
        };
        
        //setInterval(moveEnemies,50);
        
        socket.on('learnRoom', displayRoom);
        socket.on('spawnEnemies', setupEnemies);
        socket.on('enemiesUpdated', setupEnemies);
        socket.on('drawn', handleDraw);
        socket.on('move', handleMove);
        socket.on('userLeft', handleLeave);
      };
    
    window.onload = init;
    
    </script>
</head>
<body>
  <canvas id="myCanvas"></canvas>
</body>
</html>